pipeline {
    agent {
        label 'sr613'
    }
    stages {
        stage('Prepare') {
            steps {
                script {
                    def labels = ['sr613']
                    def builders = [: ]
                    for (x in labels) {
                        def label = x
                        builders[label] = {
                            node(label) {
                                cleanWs()
                                checkout scm
                                sh 'cd Dockerfile-ubuntu18.04 && docker build -t aidk-pytorch110 . -f DockerfilePytorch110 && cd .. && yes | docker container prune && yes | docker image prune'
                            }
                        }
                    }
                    parallel builders
                }
            }
        }
        stage('Run transfer_learning_unittest') {
            agent {
                label 'sr613'
            }
            steps {
                sh 'docker run --rm --name test-tlk-singlenode --privileged --network host --device=/dev/dri --shm-size="2g"  -v  /home/root/model_output:/home/vmagent/app/data/model   -v /home/root/model_zoo:/home/vmagent/app/data/pretrained -v /home/root/tensorboard:/home/vmagent/app/data/tensorboard -v /mnt/DP_disk1/dataset:/home/vmagent/app/data/dataset -v `pwd`:/home/vmagent/app -w /home/vmagent/app/test/cicd aidk-pytorch110 /bin/bash -c ". /home/vmagent/app/tests/cicd/jenkins_transfer_learning_unittest.sh"'
            }
        }
        // stage('Run transfer_learning_DDP_test') {
        //     agent {
        //        label 'sr613'
        //    }
        //    steps {
        //        sh 'docker run -t -d --name test-tlk-multinode-r1 --privileged --network host --device=/dev/dri -v  /home/root/model_output:/home/vmagent/app/data/model   -v /home/root/model_zoo:/home/vmagent/app/data/pretrained -v /home/root/tensorboard:/home/vmagent/app/data/tensorboard -v /mnt/DP_disk1/dataset:/home/vmagent/app/data/dataset -v `pwd`:/home/vmagent/app -w /home/vmagent/app/AIDK/TransferLearningKit/src aidk-pytorch110 /opt/intel/oneapi/intelpython/latest/envs/pytorch-1.10.0/bin/python main.py -s2 -r1'
        //        sh 'docker run --rm --name test-tlk-multinode-r0 --privileged --network host --device=/dev/dri -v  /home/root/model_output:/home/vmagent/app/data/model   -v /home/root/model_zoo:/home/vmagent/app/data/pretrained -v /home/root/tensorboard:/home/vmagent/app/data/tensorboard -v /mnt/DP_disk1/dataset:/home/vmagent/app/data/dataset -v `pwd`:/home/vmagent/app -w /home/vmagent/app/AIDK/TransferLearningKit/src aidk-pytorch110 /opt/intel/oneapi/intelpython/latest/envs/pytorch-1.10.0/bin/python main.py -s2 -r0'
        //    }
        // }
        stage('Run TLK_baseline_none_DDP_test') {
            agent {
                label 'sr613'
            }
            steps {
                sh 'docker run --rm --name test-tlk-singlenode --privileged --network host --device=/dev/dri --shm-size="2g"  -v  /home/root/model_output:/home/vmagent/app/data/model   -v /home/root/model_zoo:/home/vmagent/app/data/pretrained -v /home/root/tensorboard:/home/vmagent/app/data/tensorboard -v /mnt/DP_disk1/dataset:/home/vmagent/app/data/dataset -v `pwd`:/home/vmagent/app -w /home/vmagent/app/test/cicd aidk-pytorch110 /bin/bash -c ". /home/vmagent/app/tests/cicd/jenkins_transfer_learning_basic_test.sh"'
            }
        }
        stage('Run TLK_finetuner_none_DDP_test') {
            agent {
                label 'sr613'
            }
            steps {
                sh 'docker run --rm --name test-tlk-singlenode --privileged --network host --device=/dev/dri --shm-size="2g"  -v  /home/root/model_output:/home/vmagent/app/data/model   -v /home/root/model_zoo:/home/vmagent/app/data/pretrained -v /home/root/tensorboard:/home/vmagent/app/data/tensorboard -v /mnt/DP_disk1/dataset:/home/vmagent/app/data/dataset -v `pwd`:/home/vmagent/app -w /home/vmagent/app/test/cicd aidk-pytorch110 /bin/bash -c ". /home/vmagent/app/tests/cicd/jenkins_transfer_learning_finetuner_test.sh"'
            }
        }
        stage('Run TLK_distiller_none_DDP_test') {
            agent {
                label 'sr613'
            }
            steps {
                sh 'docker run --rm --name test-tlk-singlenode --privileged --network host --device=/dev/dri --shm-size="2g"  -v  /home/root/model_output:/home/vmagent/app/data/model   -v /home/root/model_zoo:/home/vmagent/app/data/pretrained -v /home/root/tensorboard:/home/vmagent/app/data/tensorboard -v /mnt/DP_disk1/dataset:/home/vmagent/app/data/dataset -v `pwd`:/home/vmagent/app -w /home/vmagent/app/test/cicd aidk-pytorch110 /bin/bash -c ". /home/vmagent/app/tests/cicd/jenkins_transfer_learning_distiller_test.sh"'
            }
        }
        stage('Run TLK_finetuner_auto_tunning_test') {
            agent {
                label 'sr613'
            }
            steps {
                sh 'docker run --rm --name test-tlk-singlenode --privileged --network host --device=/dev/dri --shm-size="2g"  -v  /home/root/model_output:/home/vmagent/app/data/model   -v /home/root/model_zoo:/home/vmagent/app/data/pretrained -v /home/root/tensorboard:/home/vmagent/app/data/tensorboard -v /mnt/DP_disk1/dataset:/home/vmagent/app/data/dataset -v `pwd`:/home/vmagent/app -w /home/vmagent/app/test/cicd aidk-pytorch110 /bin/bash -c ". /home/vmagent/app/tests/cicd/jenkins_transfer_learning_finetuner_autotuning_test.sh"'   
            }
        }
    }
    post {
        always {
            echo 'One way or another, I have finished'
            deleteDir()
            sh 'if [[ $(docker ps -a -q --filter "name=test-tlk-*" | wc -l) -ne 0 ]]; then docker ps -a -q --filter "name=test-tlk-*" | grep -q . && docker stop $(docker ps -a -q) && docker rm $(docker ps -a -q); fi'
        }
        success {
            echo 'I succeeded!'
        }
        unstable {
            echo 'I am unstable :/'
        }
        failure {
            echo 'I failed :('
        }
        changed {
            echo 'Things were different before...'
        }
    }
}