pipeline {
    agent none
    stages {
        stage('prepare sr608') {
            agent { 
                label 'sr608'
            }
            steps {
                checkout scm
                sh 'cd tests/cicd && docker build -t test-aidk -f Dockerfile . && docker build -t legacy-test-aidk -f DockerfileLegacy .'
            }
        }
        stage('prepare sr612') {
            agent { 
                label 'sr612'
            }
            steps {
                checkout scm
                sh 'cd tests/cicd && docker build -t test-aidk -f Dockerfile . && docker build -t legacy-test-aidk -f DockerfileLegacy .'
                sh 'docker run -t -d --name aidk --privileged --network host --device=/dev/dri -v /mnt/DP_disk1/dataset:/home/vmagent/app/dataset -v `pwd`:/home/vmagent/app/hydro.ai -w /home/vmagent/app/ test-aidk /bin/bash && docker exec -d aidk /bin/bash service ssh start'
                sh 'docker run -t -d --name legacy_aidk --privileged --network host --device=/dev/dri -v /mnt/DP_disk1/dataset:/home/vmagent/app/dataset -v `pwd`:/home/vmagent/app/hydro.ai -w /home/vmagent/app/ legacy-test-aidk /bin/bash && docker exec -d legacy_aidk /bin/bash service ssh start'
            }
        }
        stage('prepare sr613') {
            agent { 
                label 'sr613'
            }
            steps {
                checkout scm
                sh 'rm -f hydroai.db'
                sh 'rm -rf result'
                sh 'cd tests/cicd && docker build -t test-aidk -f Dockerfile . && docker build -t legacy-test-aidk -f DockerfileLegacy .'
            }
        }
        stage('Run distributed wnd') {
            agent { 
                label 'sr613'
            }
            steps {
                sh 'docker run --rm --privileged --network host --device=/dev/dri -v /root/cicd_logs:/home/vmagent/app/cicd_logs -v /mnt/DP_disk1/dataset:/home/vmagent/app/dataset -v `pwd`:/home/vmagent/app/hydro.ai -w /home/vmagent/app/ test-aidk /bin/bash -c "SIGOPT_API_TOKEN=$SIGOPT_API_TOKEN USE_SIGOPT=0 bash /home/vmagent/app/hydro.ai/tests/cicd/jenkins_wnd_test_dist.sh"'
                sh 'rm -f hydroai.db'
                sh 'rm -rf result'
            }
        }
        stage('Run distributed dlrm') {
            agent { 
                label 'sr613'
            }
            steps {
                sh 'docker run --rm --entrypoint "" --privileged --network host --device=/dev/dri -v /root/cicd_logs:/home/vmagent/app/cicd_logs -v /mnt/DP_disk1/dataset:/home/vmagent/app/dataset -v `pwd`:/home/vmagent/app/hydro.ai -w /home/vmagent/app/ legacy-test-aidk /bin/bash -c "SIGOPT_API_TOKEN=$SIGOPT_API_TOKEN USE_SIGOPT=0 bash /home/vmagent/app/hydro.ai/tests/cicd/jenkins_dlrm_test_dist.sh"'
                sh 'rm -f hydroai.db'
                sh 'rm -rf result'
            }
        }
        stage('clean sr612') {
            agent { 
                label 'sr612'
            }
            steps {
                sh 'docker stop $(docker ps -a -q) && docker rm $(docker ps -a -q)'
            }
        }
    }
}
