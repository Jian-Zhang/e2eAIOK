# Dockerfile for Pytorch 1.10
# Used in ModelZoo: rnnt
# Used in DeNas

FROM intel/oneapi-aikit:latest

ENV https_proxy http://child-prc.intel.com:913
ENV http_proxy http://child-prc.intel.com:913

WORKDIR /root/
RUN apt-get -o Acquire::Check-Valid-Until=false -o Acquire::Check-Date=false update -y --ignore-missing
ENV PATH /opt/intel/oneapi/intelpython/latest/condabin:$PATH
SHELL ["conda", "run", "-n", "pytorch-1.10.0", "/bin/bash", "-c"]

# install required dependencies
RUN python -m pip install pyyaml sigopt==7.5.0 prefetch_generator
RUN python -m pip install onnx tqdm
RUN python -m pip install pytest
RUN python -m pip install torchvision torchsummary easydict opencv-python scikit-image timm boto3

SHELL ["conda", "run", "-n", "base", "/bin/bash", "-c"]
RUN python -m pip install transformers

SHELL ["/bin/bash", "-c"]

RUN apt-get install -y rsync zlib1g-dev \
            zip unzip numactl
RUN sed -i 's/#Port 22/Port 12345/g' /etc/ssh/sshd_config
RUN sed -i 's/#   Port 22/    Port 12345/g' /etc/ssh/ssh_config
RUN mkdir /root/.ssh
COPY id_rsa /root/.ssh/id_rsa
RUN ssh-keygen -y -f /root/.ssh/id_rsa > /root/.ssh/id_rsa.pub
RUN cat /root/.ssh/id_rsa.pub > /root/.ssh/authorized_keys
RUN chmod 600 /root/.ssh/authorized_keys

RUN conda init bash
ENTRYPOINT [""]
